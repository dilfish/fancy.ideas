# 基于端口分散的高性能网络服务器

## linux 基础设施
- 多核 CPU 支持
- CPU 亲缘性绑定
- 多队列网卡
- 多线程

## 分散端口
多数服务基于一个公共的端口，例如 HTTP 服务的 80 端口。通过网络协议栈之后，计算模块就不需要关心端口了。

因此，我们可以设计一个内核模块，在数据包到达 netfilter 的 PREROUTING 阶段时，修改其端口。在发出的数据包到达 POSTROUTING 时，再将端口修改回原来的值。TCP 和 UDP 的 checksum 基于很简单的求和运算，因此可以迅速地通过几条 CPU 指令完成这样的修改。从而无锁地进入到 linux 的内核网络设施。

## 服务器设计
结合上述组件，可以设计出多条并行的数据流水线。每个 CPU 核心对应一个线程/进程，对应一个网卡队列，同时，对应一个修改后的端口。例如8 核心 CPU 可以设计为8软件线程，8个网卡队列，同时80-87端口的 HTTP 服务，对外依然是只开放 80 端口。合适的硬件配置可以将 CPU 和网卡同时达到 100% 满载效率。

## 现状

linux 内核在 dpdk 等项目的压力下，新版中已经提供了无锁和快速的网络包处理机制。但是编码和设计复杂性都比较高。使用上述的设计方式，可以在高性能，稳定性和编码复杂度上取得一个很好的平衡。
